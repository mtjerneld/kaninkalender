<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ calendar_title }}</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üê∞ {{ calendar_title }} üê∞</h1>
        
        <div id="login" class="login-section">
            <div class="login-box">
                <h1 class="login-title">üê∞ {{ calendar_title }} üê∞</h1>
                <h3>Logga in</h3>
                <div class="form-group">
                    <input type="password" id="password" placeholder="Ange l√∂senord" class="password-input">
                    <button onclick="checkPassword()" class="login-btn">Logga in</button>
                </div>
                <p id="login-error" class="error-message hidden">Felaktigt l√∂senord</p>
            </div>
        </div>

        <div id="calendar-content" class="hidden">
            <div class="task-list">
                <h3>Dagens uppgifter</h3>
                <div id="tasks">
                    {% for task in today_tasks %}
                    <div class="task {% if task.completed %}completed{% endif %}">
                        <button onclick="toggleTask('{{ task.id }}', 'completed')" class="task-btn">
                            Aktivitet utf√∂rd
                        </button>
                        <span>{{ task.task_type }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div id="calendar"></div>

            <div class="controls">
                <button onclick="toggleScheduleEditor()" class="editor-btn">Redigera Schema</button>
                <button onclick="logout()" class="logout-btn">Logga ut</button>
            </div>

            <div id="schedule-editor" class="schedule-editor hidden">
                <h2>Redigera Schema</h2>
                <div class="schedule-list" id="schedule-list"></div>
                <button onclick="showAddScheduleForm()" class="add-schedule-btn">+ L√§gg till ny aktivitet</button>
            </div>

            <div id="schedule-form" class="schedule-form hidden">
                <h3 id="form-title">Ny aktivitet</h3>
                <form onsubmit="saveSchedule(event)">
                    <div class="form-group">
                        <label for="schedule-title">Titel:</label>
                        <input type="text" id="schedule-title" required>
                    </div>
                    <div class="form-group">
                        <label>Veckodagar:</label>
                        <div class="weekday-checkboxes">
                            <label><input type="checkbox" value="0"> M√•n</label>
                            <label><input type="checkbox" value="1"> Tis</label>
                            <label><input type="checkbox" value="2"> Ons</label>
                            <label><input type="checkbox" value="3"> Tor</label>
                            <label><input type="checkbox" value="4"> Fre</label>
                            <label><input type="checkbox" value="5"> L√∂r</label>
                            <label><input type="checkbox" value="6"> S√∂n</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="schedule-end-date">Slutdatum (valfritt):</label>
                        <input type="date" id="schedule-end-date" 
                               min="${formatDate(new Date())}"
                               max="9999-12-31"
                               pattern="\d{4}-\d{2}-\d{2}">
                        <p class="form-help">L√§mna tomt f√∂r att schemat ska forts√§tta utan slutdatum</p>
                    </div>
                    <div class="form-buttons">
                        <button type="submit">Spara</button>
                        <button type="button" onclick="hideScheduleForm()">Avbryt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Ny aktivitet modal -->
    <div class="modal fade" id="newActivityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ny aktivitet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newActivityForm">
                        <div class="mb-3">
                            <label for="newActivityName" class="form-label">Namn</label>
                            <input type="text" class="form-control" id="newActivityName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newActivityDescription" class="form-label">Beskrivning</label>
                            <textarea class="form-control" id="newActivityDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dagar</label>
                            <div class="d-flex flex-wrap gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="0" id="newDay0">
                                    <label class="form-check-label" for="newDay0">M√•ndag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="1" id="newDay1">
                                    <label class="form-check-label" for="newDay1">Tisdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="2" id="newDay2">
                                    <label class="form-check-label" for="newDay2">Onsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="3" id="newDay3">
                                    <label class="form-check-label" for="newDay3">Torsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="4" id="newDay4">
                                    <label class="form-check-label" for="newDay4">Fredag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="5" id="newDay5">
                                    <label class="form-check-label" for="newDay5">L√∂rdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="6" id="newDay6">
                                    <label class="form-check-label" for="newDay6">S√∂ndag</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newActivityStartDate" class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="newActivityStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="newActivityEndDate" class="form-label">Slutdatum</label>
                            <input type="date" class="form-control" id="newActivityEndDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewActivity()">Spara</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Redigera aktivitet modal -->
    <div class="modal fade" id="editActivityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Redigera aktivitet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editActivityForm">
                        <div class="mb-3">
                            <label for="editActivityName" class="form-label">Namn</label>
                            <input type="text" class="form-control" id="editActivityName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editActivityDescription" class="form-label">Beskrivning</label>
                            <textarea class="form-control" id="editActivityDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dagar</label>
                            <div class="d-flex flex-wrap gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="0" id="editDay0">
                                    <label class="form-check-label" for="editDay0">M√•ndag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="1" id="editDay1">
                                    <label class="form-check-label" for="editDay1">Tisdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="2" id="editDay2">
                                    <label class="form-check-label" for="editDay2">Onsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="3" id="editDay3">
                                    <label class="form-check-label" for="editDay3">Torsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="4" id="editDay4">
                                    <label class="form-check-label" for="editDay4">Fredag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="5" id="editDay5">
                                    <label class="form-check-label" for="editDay5">L√∂rdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="6" id="editDay6">
                                    <label class="form-check-label" for="editDay6">S√∂ndag</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editActivityStartDate" class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="editActivityStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editActivityEndDate" class="form-label">Slutdatum</label>
                            <input type="date" class="form-control" id="editActivityEndDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="button" class="btn btn-primary" onclick="updateSchedule()">Spara √§ndringar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let calendar;
        let schedules = [];
        let editingScheduleId = null;

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'sv',
                firstDay: 1,
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'today'
                },
                buttonText: {
                    today: 'Idag'
                },
                eventClick: function(info) {
                    showTaskPopup(info.event);
                },
                eventDidMount: function(info) {
                    if (info.event.extendedProps.completed) {
                        info.el.classList.add('completed');
                    }
                    if (info.event.extendedProps.missed) {
                        info.el.classList.add('missed');
                    }
                },
                datesSet: function(info) {
                    loadTasks(info.start, info.end);
                }
            });
            calendar.render();
        }

        async function checkPassword() {
            try {
                const password = document.getElementById('password').value;
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    // D√∂lj hela login-sektionen
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('calendar-content').classList.remove('hidden');
                    sessionStorage.setItem('isLoggedIn', 'true');
                    
                    // Initiera kalendern direkt efter inloggning
                    initCalendar();
                    loadTasks();
                    loadSchedules();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                document.getElementById('login-error').textContent = 'Ett fel uppstod vid inloggning';
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        // L√§gg till Enter-tangent st√∂d f√∂r l√∂senordsf√§ltet
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // S√§tt dagens datum som default f√∂r startdatum
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                // D√∂lj hela login-sektionen
                document.getElementById('login').style.display = 'none';
                document.getElementById('calendar-content').classList.remove('hidden');
                
                // Initiera kalendern vid sidladdning om anv√§ndaren √§r inloggad
                initCalendar();
                loadTasks();
                loadSchedules();
            }
        });

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function showTaskPopup(event) {
            const taskId = event.extendedProps.taskId;
            const isCompleted = event.extendedProps.completed;
            const isMissed = event.extendedProps.missed;
            const originalDate = event.start;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPastOrToday = originalDate <= today;
            
            // Skapa popup-inneh√•ll
            const popupContent = document.createElement('div');
            popupContent.className = 'task-popup';
            popupContent.innerHTML = `
                <div class="popup-header">
                    <h3>${event.title}</h3>
                    <span class="rabbit-icon">üê∞</span>
                </div>
                <p>Planerat datum: ${originalDate.toLocaleDateString('sv-SE')}</p>
                ${isPastOrToday ? `
                    <div class="task-status">
                        <label>
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleTask(${taskId}, 'completed')">
                            Markera som utf√∂rd
                        </label>
                        <label>
                            <input type="checkbox" ${isMissed ? 'checked' : ''} 
                                   onchange="toggleTask(${taskId}, 'missed')">
                            Markera som missad
                        </label>
                    </div>
                ` : `
                    <p class="future-task-message">Framtida aktiviteter kan inte markeras som utf√∂rda eller missade.</p>
                `}
                <div class="reschedule-section">
                    <h4>Flytta aktivitet</h4>
                    <p>Om du flyttade denna aktivitet, v√§lj n√§r den utf√∂rdes ist√§llet:</p>
                    <input type="date" id="new-date" 
                           min="${formatDate(new Date(originalDate.getTime() - 7 * 24 * 60 * 60 * 1000))}"
                           max="${formatDate(new Date(originalDate.getTime() + 7 * 24 * 60 * 60 * 1000))}"
                           value="${formatDate(originalDate)}">
                    <button onclick="rescheduleTask(${taskId})" class="reschedule-btn">
                        Flytta aktivitet
                    </button>
                </div>
            `;
            
            // Visa popup
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.appendChild(popupContent);
            document.body.appendChild(popup);
            
            // St√§ng popup n√§r man klickar utanf√∂r
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    document.body.removeChild(popup);
                }
            });
        }

        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                schedules = await response.json();
                displaySchedules();
            } catch (error) {
                console.error('Error:', error);
                alert('Ett fel uppstod vid h√§mtning av scheman');
            }
        }

        function displaySchedules() {
            const container = document.getElementById('schedule-list');
            container.innerHTML = '';
            
            schedules.forEach(schedule => {
                const scheduleElement = document.createElement('div');
                scheduleElement.className = 'schedule-item';
                const weekdays = ['M√•n', 'Tis', 'Ons', 'Tor', 'Fre', 'L√∂r', 'S√∂n'];
                const scheduleDays = schedule.weekdays.map(day => weekdays[day]).join(', ');
                
                scheduleElement.innerHTML = `
                    <div class="schedule-info">
                        <h4>${schedule.title}</h4>
                        <p>Dagar: ${scheduleDays}</p>
                        <p>Status: ${schedule.active ? 'Aktiv' : 'Inaktiv'}</p>
                        ${schedule.start_date ? `<p>Startdatum: ${schedule.start_date}</p>` : ''}
                        ${schedule.end_date ? `<p>Slutdatum: ${schedule.end_date}</p>` : ''}
                    </div>
                    <div class="schedule-actions">
                        <button onclick="editSchedule(${schedule.id})">Redigera</button>
                        <button onclick="deleteSchedule(${schedule.id})" class="delete-btn">Ta bort</button>
                    </div>
                `;
                container.appendChild(scheduleElement);
            });
        }

        function toggleScheduleEditor() {
            const editor = document.getElementById('schedule-editor');
            editor.classList.toggle('hidden');
        }

        function showAddScheduleForm() {
            const modal = new bootstrap.Modal(document.getElementById('newActivityModal'));
            
            // S√§tt dagens datum som standardv√§rde f√∂r startdatum
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newActivityStartDate').value = today;
            
            // S√§tt ett √•r fram i tiden som standardv√§rde f√∂r slutdatum
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            document.getElementById('newActivityEndDate').value = nextYear.toISOString().split('T')[0];
            
            modal.show();
        }

        function hideScheduleForm() {
            document.getElementById('schedule-form').classList.add('hidden');
        }

        async function saveSchedule(event) {
            event.preventDefault();
            
            const title = document.getElementById('schedule-title').value;
            const weekdays = Array.from(document.querySelectorAll('.weekday-checkboxes input:checked'))
                .map(cb => parseInt(cb.value));
            const active = document.getElementById('schedule-active').checked;
            const endDate = document.getElementById('schedule-end-date').value;

            const scheduleData = {
                title,
                weekdays,
                active,
                end_date: endDate || null
            };

            const url = editingScheduleId 
                ? `/api/schedules/${editingScheduleId}`
                : '/api/schedules';
            
            const method = editingScheduleId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(scheduleData)
            });

            if (response.ok) {
                await loadSchedules();
                hideScheduleForm();
                // Uppdatera kalendern
                await loadTasks();
            }
        }

        async function editSchedule(scheduleId) {
            try {
                const response = await fetch(`/api/schedules/${scheduleId}`);
                const schedule = await response.json();
                
                document.getElementById('editActivityTitle').value = schedule.title;
                document.getElementById('editEndDate').value = schedule.end_date || '';
                document.getElementById('editStartDate').value = schedule.start_date || '';
                document.getElementById('editActiveCheck').checked = schedule.active;
                
                // √Öterst√§ll alla dagar
                for (let i = 0; i < 7; i++) {
                    document.getElementById(`editDay${i}`).checked = false;
                }
                
                // Markera valda dagar
                schedule.weekdays.forEach(day => {
                    document.getElementById(`editDay${day}`).checked = true;
                });
                
                document.getElementById('editScheduleId').value = scheduleId;
                
                const modal = new bootstrap.Modal(document.getElementById('editActivityModal'));
                modal.show();
            } catch (error) {
                console.error('Error:', error);
                alert('Ett fel uppstod vid h√§mtning av aktiviteten');
            }
        }

        async function updateSchedule() {
            const scheduleId = document.getElementById('editScheduleId').value;
            const title = document.getElementById('editActivityTitle').value;
            const weekdays = [];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`editDay${i}`).checked) {
                    weekdays.push(i);
                }
            }
            const active = document.getElementById('editActiveCheck').checked;
            const endDate = document.getElementById('editEndDate').value;
            const startDate = document.getElementById('editStartDate').value;

            if (!title || weekdays.length === 0) {
                alert('V√§nligen fyll i titel och v√§lj minst en dag');
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        weekdays,
                        active,
                        end_date: endDate || null,
                        start_date: startDate || null
                    })
                });

                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editActivityModal'));
                    modal.hide();
                    loadSchedules();
                } else {
                    const error = await response.json();
                    alert('Fel vid uppdatering: ' + error.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ett fel uppstod vid uppdatering av aktiviteten');
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('√Ñr du s√§ker p√• att du vill ta bort denna aktivitet?')) return;

            const response = await fetch(`/api/schedules/${scheduleId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                await loadSchedules();
                // Uppdatera kalendern
                await loadTasks();
            }
        }

        async function rescheduleTask(taskId) {
            const newDate = document.getElementById('new-date').value;
            if (!newDate) return;

            const response = await fetch(`/api/tasks/${taskId}/reschedule`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ new_date: newDate })
            });
            
            if (response.ok) {
                loadTasks();
                // St√§ng popup
                const popup = document.querySelector('.popup-overlay');
                if (popup) {
                    document.body.removeChild(popup);
                }
            }
        }

        async function loadTasks(startDate, endDate) {
            if (!startDate) {
                startDate = calendar.view.currentStart;
            }
            if (!endDate) {
                endDate = calendar.view.currentEnd;
            }
            
            try {
                const response = await fetch(`/api/tasks?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`);
                if (!response.ok) {
                    throw new Error('Kunde inte h√§mta uppgifter');
                }
                const tasks = await response.json();
                
                // Rensa kalendern
                calendar.removeAllEvents();
                
                // L√§gg till uppgifterna i kalendern
                tasks.forEach(task => {
                    const event = {
                        id: task.id,
                        title: task.task_type || task.name, // Anv√§nd task_type om det finns, annars name
                        start: task.date,
                        extendedProps: {
                            taskId: task.id,
                            description: task.description,
                            completed: task.completed,
                            missed: task.missed
                        }
                    };
                    
                    if (task.completed) {
                        event.classNames = ['completed'];
                    } else if (task.missed) {
                        event.classNames = ['missed'];
                    }
                    
                    calendar.addEvent(event);
                });
            } catch (error) {
                console.error('Fel vid laddning av uppgifter:', error);
            }
        }

        async function toggleTask(taskId, status) {
            const response = await fetch(`/api/tasks/${taskId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: status })
            });
            
            if (response.ok) {
                loadTasks();
                // St√§ng popup
                const popup = document.querySelector('.popup-overlay');
                if (popup) {
                    document.body.removeChild(popup);
                }
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST'
                });
                
                // Ta bort inloggningsstatus
                sessionStorage.removeItem('isLoggedIn');
                
                // Ta bort kalendern
                if (calendar) {
                    calendar.destroy();
                    calendar = null;
                }
                
                // Visa login-rutan och d√∂lj kalenderinneh√•llet
                document.getElementById('login').style.display = 'block';
                document.getElementById('calendar-content').classList.add('hidden');
                
                // Rensa l√∂senordsf√§ltet och felmeddelanden
                document.getElementById('password').value = '';
                document.getElementById('login-error').classList.add('hidden');
            } catch (error) {
                console.error('Error during logout:', error);
            }
        }

        async function saveNewActivity() {
            const name = document.getElementById('newActivityName').value;
            const description = document.getElementById('newActivityDescription').value;
            const days = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => parseInt(cb.value));
            const startDate = document.getElementById('newActivityStartDate').value;
            const endDate = document.getElementById('newActivityEndDate').value;

            if (!name || days.length === 0 || !startDate || !endDate) {
                alert('V√§nligen fyll i alla obligatoriska f√§lt');
                return;
            }

            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: name,
                        description,
                        weekdays: days,
                        start_date: startDate,
                        end_date: endDate,
                        active: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Kunde inte skapa aktiviteten');
                }

                const newSchedule = await response.json();
                schedules.push(newSchedule);
                displaySchedules();
                loadTasks(); // Ladda om uppgifterna f√∂r att visa det nya schemat
                bootstrap.Modal.getInstance(document.getElementById('newActivityModal')).hide();
                
                // √Öterst√§ll formul√§ret
                document.getElementById('newActivityForm').reset();
            } catch (error) {
                console.error('Fel vid skapande av aktivitet:', error);
                alert(error.message || 'Ett fel uppstod n√§r aktiviteten skulle skapas');
            }
        }

        async function editSchedule(id) {
            const schedule = schedules.find(s => s.id === id);
            if (!schedule) return;

            document.getElementById('editActivityName').value = schedule.title;
            document.getElementById('editActivityDescription').value = schedule.description || '';
            document.getElementById('editActivityStartDate').value = schedule.start_date;
            document.getElementById('editActivityEndDate').value = schedule.end_date;

            // √Öterst√§ll alla checkboxar
            document.querySelectorAll('input[name="editDays"]').forEach(cb => {
                cb.checked = false;
            });

            // Markera de valda dagarna
            schedule.weekdays.forEach(day => {
                const checkbox = document.querySelector(`input[name="editDays"][value="${day}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Spara schedule ID f√∂r uppdatering
            document.getElementById('editActivityForm').dataset.scheduleId = id;

            const editModal = new bootstrap.Modal(document.getElementById('editActivityModal'));
            editModal.show();
        }

        async function updateSchedule() {
            const id = document.getElementById('editActivityForm').dataset.scheduleId;
            const name = document.getElementById('editActivityName').value;
            const description = document.getElementById('editActivityDescription').value;
            const days = Array.from(document.querySelectorAll('input[name="editDays"]:checked')).map(cb => parseInt(cb.value));
            const startDate = document.getElementById('editActivityStartDate').value;
            const endDate = document.getElementById('editActivityEndDate').value;

            if (!name || days.length === 0 || !startDate || !endDate) {
                alert('V√§nligen fyll i alla obligatoriska f√§lt');
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: name,
                        description,
                        weekdays: days,
                        start_date: startDate,
                        end_date: endDate,
                        active: true
                    })
                });

                if (!response.ok) {
                    throw new Error('Kunde inte uppdatera aktiviteten');
                }

                const updatedSchedule = await response.json();
                const index = schedules.findIndex(s => s.id === id);
                if (index !== -1) {
                    schedules[index] = updatedSchedule;
                }
                displaySchedules();
                loadTasks(); // Ladda om uppgifterna f√∂r att visa √§ndringarna
                bootstrap.Modal.getInstance(document.getElementById('editActivityModal')).hide();
            } catch (error) {
                console.error('Fel vid uppdatering av aktivitet:', error);
                alert('Ett fel uppstod n√§r aktiviteten skulle uppdateras');
            }
        }
    </script>
</body>
</html> 