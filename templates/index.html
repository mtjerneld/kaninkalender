<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ calendar_title }}</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="main-title">üê∞ {{ calendar_title }} üê∞</h1>
        
        <div id="login" class="login-section">
            <div class="login-content">
                <h1 class="login-title">üê∞ {{ calendar_title }} üê∞</h1>
                <div class="login-box">
                    <h3>Logga in</h3>
                    <div class="form-group">
                        <input type="password" id="password" placeholder="Ange l√∂senord" class="password-input">
                        <button onclick="checkPassword()" class="login-btn">Logga in</button>
                    </div>
                    <p id="login-error" class="error-message hidden">Felaktigt l√∂senord</p>
                </div>
            </div>
        </div>

        <div id="calendar-content" class="hidden">
            <div class="task-list">
                <h3>Dagens uppgifter</h3>
                <div id="tasks">
                    {% for task in today_tasks %}
                    <div class="task {% if task.completed %}completed{% endif %}" data-task-id="{{ task.id }}">
                        <button onclick="toggleTask('{{ task.id }}', 'completed')" class="task-btn">
                            Aktivitet utf√∂rd
                        </button>
                        <span>{{ task.task_type }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div id="calendar"></div>

            <div class="controls">
                <button onclick="toggleScheduleEditor()" class="editor-btn">Redigera Schema</button>
                <button onclick="logout()" class="logout-btn">Logga ut</button>
            </div>

            <div id="schedule-editor" class="schedule-editor hidden">
                <h2>Redigera Schema</h2>
                <div class="schedule-list" id="schedule-list"></div>
                <button onclick="showAddScheduleForm()" class="add-schedule-btn">+ L√§gg till ny aktivitet</button>
            </div>

            <div id="schedule-form" class="schedule-form hidden">
                <h3 id="form-title">Ny aktivitet</h3>
                <form onsubmit="saveSchedule(event)">
                    <div class="form-group">
                        <label for="schedule-title">Titel:</label>
                        <input type="text" id="schedule-title" required>
                    </div>
                    <div class="form-group">
                        <label>Veckodagar:</label>
                        <div class="weekday-checkboxes">
                            <label><input type="checkbox" value="0"> M√•n</label>
                            <label><input type="checkbox" value="1"> Tis</label>
                            <label><input type="checkbox" value="2"> Ons</label>
                            <label><input type="checkbox" value="3"> Tor</label>
                            <label><input type="checkbox" value="4"> Fre</label>
                            <label><input type="checkbox" value="5"> L√∂r</label>
                            <label><input type="checkbox" value="6"> S√∂n</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="schedule-end-date">Slutdatum (valfritt):</label>
                        <input type="date" id="schedule-end-date" 
                               min="${formatDate(new Date())}"
                               max="9999-12-31"
                               pattern="\d{4}-\d{2}-\d{2}">
                        <p class="form-help">L√§mna tomt f√∂r att schemat ska forts√§tta utan slutdatum</p>
                    </div>
                    <div class="form-buttons">
                        <button type="submit">Spara</button>
                        <button type="button" onclick="hideScheduleForm()">Avbryt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Ny aktivitet modal -->
    <div class="modal fade" id="newActivityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ny aktivitet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newActivityForm">
                        <div class="mb-3">
                            <label for="newActivityName" class="form-label">Namn</label>
                            <input type="text" class="form-control" id="newActivityName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newActivityDescription" class="form-label">Beskrivning</label>
                            <textarea class="form-control" id="newActivityDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dagar</label>
                            <div class="d-flex flex-wrap gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="0" id="newDay0">
                                    <label class="form-check-label" for="newDay0">M√•ndag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="1" id="newDay1">
                                    <label class="form-check-label" for="newDay1">Tisdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="2" id="newDay2">
                                    <label class="form-check-label" for="newDay2">Onsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="3" id="newDay3">
                                    <label class="form-check-label" for="newDay3">Torsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="4" id="newDay4">
                                    <label class="form-check-label" for="newDay4">Fredag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="5" id="newDay5">
                                    <label class="form-check-label" for="newDay5">L√∂rdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="6" id="newDay6">
                                    <label class="form-check-label" for="newDay6">S√∂ndag</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newActivityStartDate" class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="newActivityStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="newActivityEndDate" class="form-label">Slutdatum</label>
                            <input type="date" class="form-control" id="newActivityEndDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewActivity()">Spara</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Redigera aktivitet modal -->
    <div class="modal fade" id="editActivityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Redigera aktivitet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editActivityForm">
                        <div class="mb-3">
                            <label for="editActivityName" class="form-label">Namn</label>
                            <input type="text" class="form-control" id="editActivityName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editActivityDescription" class="form-label">Beskrivning</label>
                            <textarea class="form-control" id="editActivityDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dagar</label>
                            <div class="d-flex flex-wrap gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="0" id="editDay0">
                                    <label class="form-check-label" for="editDay0">M√•ndag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="1" id="editDay1">
                                    <label class="form-check-label" for="editDay1">Tisdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="2" id="editDay2">
                                    <label class="form-check-label" for="editDay2">Onsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="3" id="editDay3">
                                    <label class="form-check-label" for="editDay3">Torsdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="4" id="editDay4">
                                    <label class="form-check-label" for="editDay4">Fredag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="5" id="editDay5">
                                    <label class="form-check-label" for="editDay5">L√∂rdag</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="editDays" value="6" id="editDay6">
                                    <label class="form-check-label" for="editDay6">S√∂ndag</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editActivityStartDate" class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="editActivityStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editActivityEndDate" class="form-label">Slutdatum</label>
                            <input type="date" class="form-control" id="editActivityEndDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="button" class="btn btn-primary" onclick="updateSchedule()">Spara √§ndringar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let calendar;
        let schedules = [];
        let editingScheduleId = null;

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'sv',
                firstDay: 1,
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'today'
                },
                buttonText: {
                    today: 'Idag'
                },
                eventClick: function(info) {
                    showTaskPopup(info.event);
                },
                eventDidMount: function(info) {
                    if (info.event.extendedProps.completed) {
                        info.el.classList.add('completed');
                    }
                    if (info.event.extendedProps.missed) {
                        info.el.classList.add('missed');
                    }
                },
                datesSet: function(info) {
                    loadTasks(info.start, info.end);
                }
            });
            calendar.render();
        }

        async function checkPassword() {
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            const loginBtn = document.querySelector('.login-btn');
            const loginBox = document.querySelector('.login-box');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('calendar-content').classList.remove('hidden');
                    
                    initCalendar();
                    loadTasks();
                    loadSchedules();
                } else {
                    loginError.textContent = data.error || 'Felaktigt l√∂senord';
                    loginError.classList.remove('hidden');
                    document.getElementById('password').value = '';
                    
                    // Om anv√§ndaren √§r blockerad, visa nedr√§kning
                    if (response.status === 429) {
                        const originalContent = loginBox.innerHTML;
                        const blockEndTime = Date.now() + (30 * 1000);
                        sessionStorage.setItem('loginBlockEndTime', blockEndTime);
                        startBlockCountdown(loginBox, originalContent);
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Ett fel uppstod vid inloggning';
                loginError.classList.remove('hidden');
            }
        }

        function startBlockCountdown(loginBox, originalContent) {
            const blockEndTime = parseInt(sessionStorage.getItem('loginBlockEndTime'));
            const updateCountdown = () => {
                const now = Date.now();
                const secondsLeft = Math.max(0, Math.ceil((blockEndTime - now) / 1000));
                
                if (secondsLeft > 0) {
                    loginBox.innerHTML = `
                        <h3>F√∂r m√•nga f√∂rs√∂k</h3>
                        <p>F√∂rs√∂k igen om ${secondsLeft} sekunder</p>
                    `;
                    setTimeout(updateCountdown, 1000);
                } else {
                    sessionStorage.removeItem('loginBlockEndTime');
                    loginBox.innerHTML = originalContent;
                    document.getElementById('login-error').classList.add('hidden');
                }
            };
            
            updateCountdown();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Kontrollera om anv√§ndaren √§r blockerad vid sidladdning
            const blockEndTime = sessionStorage.getItem('loginBlockEndTime');
            if (blockEndTime) {
                const loginBox = document.querySelector('.login-box');
                const originalContent = loginBox.innerHTML;
                startBlockCountdown(loginBox, originalContent);
            }
            
            fetch('/api/check-session', {
                credentials: 'include'  // L√§gg till credentials
            })
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        document.getElementById('login').style.display = 'none';
                        document.getElementById('calendar-content').classList.remove('hidden');
                        
                        initCalendar();
                        loadTasks();
                        loadSchedules();
                    }
                })
                .catch(error => {
                    console.error('Fel vid kontroll av session:', error);
                });
        });

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function showTaskPopup(event) {
            const taskId = event.extendedProps.taskId;
            const isCompleted = event.extendedProps.completed;
            const isMissed = event.extendedProps.missed;
            const description = event.extendedProps.description;
            const originalDate = event.start;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPastOrToday = originalDate <= today;
            
            const popupContent = document.createElement('div');
            popupContent.className = 'task-popup';
            popupContent.innerHTML = `
                <div class="popup-header">
                    <h3>${event.title}</h3>
                    <span class="rabbit-icon">üê∞</span>
                </div>
                ${description ? `<p class="task-description">${description}</p>` : ''}
                <p>Planerat datum: ${event.start.toLocaleDateString('sv-SE')}</p>
                ${isPastOrToday ? `
                    <div class="task-status">
                        <label>
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleTask(${taskId}, 'completed')">
                            Markera som utf√∂rd
                        </label>
                        <label>
                            <input type="checkbox" ${isMissed ? 'checked' : ''} 
                                   onchange="toggleTask(${taskId}, 'missed')">
                            Markera som missad
                        </label>
                    </div>
                ` : `
                    <p class="future-task-message">Framtida aktiviteter kan inte markeras som utf√∂rda eller missade.</p>
                `}
                <div class="reschedule-section">
                    <h4>Flytta aktivitet</h4>
                    <p>Om du flyttade denna aktivitet, v√§lj n√§r den utf√∂rdes ist√§llet:</p>
                    <input type="date" id="new-date" 
                           min="${formatDate(new Date(event.start.getTime() - 7 * 24 * 60 * 60 * 1000))}"
                           max="${formatDate(new Date(event.start.getTime() + 7 * 24 * 60 * 60 * 1000))}"
                           value="${formatDate(event.start)}">
                    <button onclick="rescheduleTask(${taskId})" class="reschedule-btn">
                        Flytta aktivitet
                    </button>
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.appendChild(popupContent);
            document.body.appendChild(popup);
            
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    document.body.removeChild(popup);
                }
            });
        }

        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules', {
                    credentials: 'include'
                });
                schedules = await response.json();
                displaySchedules();
            } catch (error) {
                console.error('Error:', error);
                alert('Ett fel uppstod vid h√§mtning av scheman');
            }
        }

        function displaySchedules() {
            const container = document.getElementById('schedule-list');
            container.innerHTML = '';
            
            schedules.forEach(schedule => {
                const scheduleElement = document.createElement('div');
                scheduleElement.className = 'schedule-item';
                const weekdays = ['M√•n', 'Tis', 'Ons', 'Tor', 'Fre', 'L√∂r', 'S√∂n'];
                const scheduleDays = schedule.weekdays.map(day => weekdays[day]).join(', ');
                
                scheduleElement.innerHTML = `
                    <div class="schedule-info">
                        <h4>${schedule.title}</h4>
                        ${schedule.description ? `<p class="schedule-description">${schedule.description}</p>` : ''}
                        <p>Dagar: ${scheduleDays}</p>
                        <p>Status: ${schedule.active ? 'Aktiv' : 'Inaktiv'}</p>
                        ${schedule.start_date ? `<p>Startdatum: ${schedule.start_date}</p>` : ''}
                        ${schedule.end_date ? `<p>Slutdatum: ${schedule.end_date}</p>` : ''}
                    </div>
                    <div class="schedule-actions">
                        <button onclick="editSchedule(${schedule.id})">Redigera</button>
                        <button onclick="deleteSchedule(${schedule.id})" class="delete-btn">Ta bort</button>
                    </div>
                `;
                container.appendChild(scheduleElement);
            });
        }

        function toggleScheduleEditor() {
            const editor = document.getElementById('schedule-editor');
            editor.classList.toggle('hidden');
        }

        function showAddScheduleForm() {
            const modal = new bootstrap.Modal(document.getElementById('newActivityModal'));
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newActivityStartDate').value = today;
            
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            document.getElementById('newActivityEndDate').value = nextYear.toISOString().split('T')[0];
            
            modal.show();
        }

        function hideScheduleForm() {
            document.getElementById('schedule-form').classList.add('hidden');
        }

        async function saveSchedule(event) {
            event.preventDefault();
            
            const title = document.getElementById('schedule-title').value;
            const weekdays = Array.from(document.querySelectorAll('.weekday-checkboxes input:checked'))
                .map(cb => parseInt(cb.value));
            const active = document.getElementById('schedule-active').checked;
            const endDate = document.getElementById('schedule-end-date').value;

            const scheduleData = {
                title,
                weekdays,
                active,
                end_date: endDate || null
            };

            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(scheduleData)
                });

                if (response.ok) {
                    hideScheduleForm();
                    await loadSchedules();  // Uppdatera schemalisten
                    await loadTasks();      // Uppdatera kalendern
                    calendar.refetchEvents(); // Uppdatera kalendervy
                } else {
                    const data = await response.json();
                    alert(data.error || 'Ett fel uppstod n√§r schemat skulle sparas');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ett fel uppstod n√§r schemat skulle sparas');
            }
        }

        async function editSchedule(id) {
            const schedule = schedules.find(s => s.id === id);
            if (!schedule) return;

            editingScheduleId = id;  // S√§tt det aktuella schemat som redigeras
            
            // Fyll i formul√§ret med schemats data
            document.getElementById('editActivityName').value = schedule.title;
            document.getElementById('editActivityDescription').value = schedule.description || '';  // L√§gg till beskrivning
            document.getElementById('editActivityStartDate').value = schedule.start_date;
            document.getElementById('editActivityEndDate').value = schedule.end_date || '';

            // √Öterst√§ll och markera r√§tt veckodagar
            document.querySelectorAll('input[name="editDays"]').forEach(cb => {
                cb.checked = schedule.weekdays.includes(parseInt(cb.value));
            });

            // Visa modal
            const editModal = new bootstrap.Modal(document.getElementById('editActivityModal'));
            editModal.show();
        }

        async function updateSchedule() {
            if (!editingScheduleId) {
                alert('Inget schema valt f√∂r redigering');
                return;
            }

            const title = document.getElementById('editActivityName').value;
            const description = document.getElementById('editActivityDescription').value;
            const weekdays = Array.from(document.querySelectorAll('input[name="editDays"]:checked'))
                .map(cb => parseInt(cb.value));
            const startDate = document.getElementById('editActivityStartDate').value;
            const endDate = document.getElementById('editActivityEndDate').value;

            if (!title || weekdays.length === 0 || !startDate) {
                alert('V√§nligen fyll i alla obligatoriska f√§lt');
                return;
            }

            const scheduleData = {
                title,
                description,
                weekdays,
                start_date: startDate,
                end_date: endDate || null,
                active: true
            };

            try {
                const response = await fetch(`/api/schedules/${editingScheduleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(scheduleData)
                });

                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editActivityModal'));
                    modal.hide();
                    await loadSchedules();  // Uppdatera schemalisten
                    await loadTasks();      // Uppdatera kalendern
                    calendar.refetchEvents(); // Uppdatera kalendervy
                    editingScheduleId = null;  // √Öterst√§ll redigerings-ID
                } else {
                    const data = await response.json();
                    alert(data.error || 'Ett fel uppstod n√§r schemat skulle uppdateras');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ett fel uppstod n√§r schemat skulle uppdateras');
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('√Ñr du s√§ker p√• att du vill ta bort detta schema?')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    await loadSchedules();  // Uppdatera schemalisten
                    await loadTasks();      // Uppdatera kalendern
                    calendar.refetchEvents(); // Uppdatera kalendervy
                } else {
                    alert('Ett fel uppstod n√§r schemat skulle tas bort');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ett fel uppstod n√§r schemat skulle tas bort');
            }
        }

        async function rescheduleTask(taskId) {
            const newDate = document.getElementById('new-date').value;
            if (!newDate) return;

            const response = await fetch(`/api/tasks/${taskId}/reschedule`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({ new_date: newDate })
            });
            
            if (response.ok) {
                loadTasks();
                const popup = document.querySelector('.popup-overlay');
                if (popup) {
                    document.body.removeChild(popup);
                }
            }
        }

        async function loadTasks(startDate, endDate) {
            if (!startDate) {
                startDate = calendar.view.currentStart;
            }
            if (!endDate) {
                endDate = calendar.view.currentEnd;
            }
            
            try {
                const response = await fetch(`/api/tasks?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Kunde inte h√§mta uppgifter');
                }
                const tasks = await response.json();
                
                calendar.removeAllEvents();
                
                tasks.forEach(task => {
                    const event = {
                        id: task.id,
                        title: task.task_type || task.name,
                        start: task.date,
                        extendedProps: {
                            taskId: task.id,
                            description: task.description,
                            completed: task.completed,
                            missed: task.missed
                        }
                    };
                    
                    if (task.completed) {
                        event.classNames = ['completed'];
                    } else if (task.missed) {
                        event.classNames = ['missed'];
                    }
                    
                    calendar.addEvent(event);
                });
            } catch (error) {
                console.error('Fel vid laddning av uppgifter:', error);
            }
        }

        async function toggleTask(taskId, status) {
            const response = await fetch(`/api/tasks/${taskId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({ status: status })
            });

            if (response.ok) {
                const updatedTask = await response.json();

                // Hitta och uppdatera DOM-elementet
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    // Toggle completed-klassen p√• task-elementet
                    taskElement.classList.toggle('completed', updatedTask.completed);
                    taskElement.classList.toggle('missed', updatedTask.missed);
                    
                    // Toggle completed-klassen p√• knappen
                    const button = taskElement.querySelector('.task-btn');
                    if (button) {
                        button.classList.toggle('completed', updatedTask.completed);
                    }
                    
                    // Toggle completed-klassen p√• span-elementet
                    const span = taskElement.querySelector('span');
                    if (span) {
                        span.classList.toggle('completed', updatedTask.completed);
                    }
                }

                // Uppdatera kalendern
                await loadTasks(calendar.view.currentStart, calendar.view.currentEnd);
                
                // St√§ng popup om den finns
                const popup = document.querySelector('.popup-overlay');
                if (popup) {
                    document.body.removeChild(popup);
                }
            }
        }

        async function loadTodayTasks() {
            try {
                const response = await fetch('/api/tasks/today');
                if (!response.ok) {
                    throw new Error('Kunde inte h√§mta dagens uppgifter');
                }
                const tasks = await response.json();
                
                const tasksContainer = document.getElementById('tasks');
                tasksContainer.innerHTML = '';
                
                tasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = `task ${task.completed ? 'completed' : ''}`;
                    taskElement.setAttribute('data-task-id', task.id);
                    taskElement.innerHTML = `
                        <button onclick="toggleTask('${task.id}', 'completed')" class="task-btn">
                            Aktivitet utf√∂rd
                        </button>
                        <span>${task.task_type}</span>
                    `;
                    tasksContainer.appendChild(taskElement);
                });
            } catch (error) {
                console.error('Fel vid laddning av dagens uppgifter:', error);
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'  // L√§gg till credentials
                });
                
                document.getElementById('login').style.display = 'block';
                document.getElementById('calendar-content').classList.add('hidden');
                
                document.getElementById('password').value = '';
                document.getElementById('login-error').classList.add('hidden');
                
                if (calendar) {
                    calendar.destroy();
                    calendar = null;
                }
            } catch (error) {
                console.error('Error during logout:', error);
            }
        }

        async function saveNewActivity() {
            const name = document.getElementById('newActivityName').value;
            const description = document.getElementById('newActivityDescription').value;
            const days = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => parseInt(cb.value));
            const startDate = document.getElementById('newActivityStartDate').value;
            const endDate = document.getElementById('newActivityEndDate').value;

            if (!name || days.length === 0 || !startDate || !endDate) {
                alert('V√§nligen fyll i alla obligatoriska f√§lt');
                return;
            }

            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: name,
                        description,
                        weekdays: days,
                        start_date: startDate,
                        end_date: endDate,
                        active: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Kunde inte skapa aktiviteten');
                }

                const newSchedule = await response.json();
                schedules.push(newSchedule);
                displaySchedules();
                loadTasks();
                bootstrap.Modal.getInstance(document.getElementById('newActivityModal')).hide();
                
                document.getElementById('newActivityForm').reset();
            } catch (error) {
                console.error('Fel vid skapande av aktivitet:', error);
                alert(error.message || 'Ett fel uppstod n√§r aktiviteten skulle skapas');
            }
        }
    </script>
</body>
</html> 